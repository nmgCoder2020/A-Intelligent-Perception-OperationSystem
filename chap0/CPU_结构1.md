##第0章  基础知识

###0.1 处理器性能与流水线设计

####0.1.0 计算机的指令集

####简单指令集：

采用复杂指令系统的计算机有着较强的处理高级语言的能力，这对提高计算机的性能是有益的。当计算机的设计沿着这条道路发展时，有些人没有随波逐流，他们回过头去看一看过去走过的道路，开始怀疑这种传统的做法：IBM公司没在纽约Yorktown的JhomasI.Wason研究中心于1975年组织力量研究指令系统的合理性问题，因为当时已感到，日趋庞杂的指令系统不但不易实现。而且还可能降低系统性能．1979年以帕特逊教授为首的一批科学家也开始在美国加册大学伯克莱分校开展这一研究。结果表明，CISC存在许多缺点。

首先，在这种计算机中，各种指令的使用率相差悬殊：一个典型程序的运算过程所使用的80%指令，只占一个处理器指令系统的20%。事实上最频繁使用的指令是取、存和加这些最简单的指令。这样一来，长期致力于复杂指令系统的设计，实际上是在设计一种难得在实践中用得上的指令系统的处理器。

同时，复杂的指令系统必然带来结构的复杂性。这不但增加了设计的时间与成本还容易造成设计失误。此外，尽管VLSI技术现在已达到很高的水平，但也很难把CISC的全部硬件做在一个芯片上，这也妨碍单片计算机的发展。在CISC中，许多复杂指令需要极复杂的操作，这类指令多数是某种高级语言的直接翻版，因而通用性差。由于采用二级的微码执行方式，它也降低那些被频繁调用的简单指令系统的运行速度。因而，针对CISC的这些弊病，帕特逊等人提出了精简指令的设想即指令系统应当只包含那些使用频率很高的少量指令，并提供一些必要的指令以支持操作系统和高级语言。按照这个原则发展而成的计算机被称为精简指令集计算机(Reduced Instruction Set Computer-RISC)结构，简称RISC。

####复杂指令集CISC：

长期来，计算机性能的提高往往是通过增加硬件的复杂性来获得。随着集成电路技术，特别是VLSI（超大规模集成电路）技术的迅速发展，为了软件编程方便和提高程序的运行速度，硬件工程师采用的办法是不断增加可实现复杂功能的指令和多种灵活的编址方式。甚至某些指令可支持高级语言语句归类后的复杂操作。至使硬件越来越复杂，造价也相应提高。为实现复杂操作，微处理器除向程序员提供类似各种寄存器和机器指令功能外．还通过存于只读存贮器(ROM)中的微程序来实现其极强的功能，微处理在分析每一条指令之后执行一系列初级指令运算来完成所需的功能，这种设计的型式被称为复杂指令集计算机(Complex Instruction Set Computer-CISC)结构。一般CISC计算机所含的指令数目至少300条以上，有的甚至超过500条。

####CISC 和 RISC 的区别：

我们经常谈论有关“PC”与“Macintosh”的话题，但是又有多少人知道以Intel公司X86为核心的PC系列正是基于CISC体系结构，而 Apple公司的Macintosh则是基于RISC体系结构，CISC与RISC到底有何区别？

从硬件角度来看CISC处理的是不等长指令集，它必须对不等长指令进行分割，因此在执行单一指令的时候需要进行较多的处理工作。而RISC执行的是等长精简指令集，CPU在执行指令的时候速度较快且性能稳定。因此在并行处理方面RISC明显优于CISC，RISC可同时执行多条指令，它可将一条指令分割成若干个进程或线程，交由多个处理器同时执行。由于RISC执行的是精简指令集，所以它的制造工艺简单且成本低廉。

从软件角度来看，CISC 运行的则是我们所熟识的DOS、Windows操作系统。而且它拥有大量的应用程序。因为全世界有65%以上的软件厂商都理为基于CISC体系结构的PC 及其兼容机服务的，象赫赫有名的Microsoft就是其中的一家。而RISC在此方面却显得有些势单力薄。虽然在RISC上也可运行DOS、 Windows，但是需要一个翻译过程，所以运行速度要慢许多。

简单而言，复杂指令集和精简指令集的设计思路是完全不同，两种处理器在工作时的思考方式也有很大的区别。复杂指令集更适合处理一些高密度的计算任务，而精简指令集则更适合处理器做一些简单重复的任务。打个比方，如果要让我们执行早上起床上班的任务应该怎么做呢？复杂指令集此时只要对我们下达上班的命令，我们就会自动执行一系列复杂的动作，如起床、穿衣、洗涮、出门、上车等命令；而精简指令集则要单独向我们下达一个一个简单的指令，让我们一步一步执行他下达的命令，最终达成上班的目的。

这就是两者为什么不好比较性能的原因，这样的思路导致了CISC和RISC两种处理器的巨大差异，前者更加专注于高性能但同时也需要高功耗，而后者则专注于小尺寸低功耗的领域。执行高密度的运算任务的时候CISC更具备优势，而执行简单重复劳动的时候RISC就能占到上风。

####现在的CISC 和 RISC 的发展：

现在不论是复杂指令集还是简单指令集逐步的走向你中由我，我中有你的境地，他们互相借鉴，X86是复杂指令集，很多复杂指令集被翻译成一些简单指令，例如最初名的ARM结构，就是简单指令集，但是现在也有很多复杂指令被加到了简单指令集中。

####时钟周期

时钟周期也称为振荡周期，定义为时钟频率的倒数。时钟周期是计算机中最基本的、最小的时间单位。在一个时钟周期内，CPU仅完成一个最基本的动作。时钟周期是一个时间的量。时钟周期表示了SDRAM所能运行的最高频率。更小的时钟周期就意味着更高的工作频率。时钟周期是同步电路中时钟基础频率的倒数。它以时间动作重复的最小周期来度量，度量单位采用时间单位。在单个时钟周期内（现代非嵌入式微处理器的这个时间一般都短于1纳秒），逻辑零状态与逻辑一状态来回切换。由于发热和电气规格的限制，周期里逻辑零状态的持续时间历来要长于逻辑一状态。

时钟周期是由CPU时钟定义的定长时间间隔，是CPU工作的最小时间单位，也称节拍脉冲或T周期。
时钟周期表示了SDRAM所能运行的最高频率。更小的时钟周期就意味着更高的工作频率。对于PC100规格的内存来说，它的运行时钟周期应该不高于10纳秒。纳秒与工作频率之间的转换关系为：1 / 时钟周期 =工作频率。例如，标称10纳秒的PC100内存芯片，其工作频率的表达式就应该是1/ 10 = 100MHZ，这说明此内存芯片的额定工作频率为100MHZ。市场上一些质量优秀的内存通常可以工作在比额定频率高的频率下，这为一些喜欢超频的朋友带来了极大的方便。例如KingMAX的PC100内存，此类内存多采用8纳秒的芯片，相对于其100MHZ的频率来说，频率提高的余地还很大，许多用户都可以让它们工作在133MHZ甚至更高的频率下。能不能超频使用很大程度上反应了内存芯片以及PCB板的质量。不过，仅仅凭借时钟周期来判断内存的速度还是不够的，内存CAS的存取时间和延迟时间也在一定程度上决定了内存的性能。

####0.1.1  时间与空间性能指标

程序与内存之间的三个假设：

1.很多软件的代码不会被经常执行，例如我们最好每次都检查系统调用的返回值，但是错误处理的信息总是不会被处理到。

2.处理器技术的进步，流水线技术的应用，模糊了复杂指令串行比简单指令的优势。

3.编程的方式有汇编转向高级语言，指令集的有用程度的衡量变成了它对编写编译器的人来说多么的有用。

4.半导体技术和超大规模集成电路的进步，内存逐渐不再是关心的重点。

影响处理器运行一个程序执行时间的一个因素：

@：这个程序的指令个数。

@：每条指令所需要的微状态。每一个微状态需要一个CPU周期来执行，每条指令的执行时间就可以由每条指令所用到的时钟周期个数。（CPI 每指令时钟周期数）。

@：决定执行时间的第三个因素是处理器的时钟周期。

我们经常考虑平均CPI

     执行时间 = n * CPI * 时钟周期时间；
     
程序的执行时间是处理器性能的主要决定因素。由于时钟周期经常变化，时钟周期（执行一个程序所使用的时钟周期的个数）是一个更加恰当的处理器性能标准，无论如何，应当说处理器性能不仅仅是处理器速度。处理器速度很重要，但是时钟周期数，即执行的指令个数与平均CPI的乘积，也是一个重要的指标，简单来说就是CPU的速度需要很快，同样的指令集的设计必须很好，所以复杂与简单才会有争议吧。

####0.1.2 指令频率

静态指令频率：
特定指令在编译得到的代码中的出现次数。这种指令影响内存的空间，通过优化指令我们可以减少内存的冗余。

动态指令频率：
特定指令在执行时运行的次数。影响系统的执行时间，我们可以通过优化来直接减少执行时间。

另外：内存越来越大静态指令已经不再需要静态指令过于优化了，这样对于CPU的流水线工作方式不利。

####0.1.3 提升处理器性能
1.减少是时钟周期。

2.改进数据通路组织减少CPI。

以上的两个点主要是在硬件上下功夫，降低单条指令的延时。以使总时间积累越来越少，另一个时直接减少执行的指令条数。

3.减少指令条数。
这个思路简单来说就是使用复杂指令替换多条简单指令，但是必须仔细考虑CPI，时钟周期时间，动态指令频率。编译优化也是减少指令数的重要方法。

###0.1.4  三种冒险

1.结构冒险：例如单一数据总线就是流水线实现的一个结构性冒险。

2.数据冒险：主要是处理指令之间的依赖关系，可能出现的冒险。

3.控制冒险：指程序由于分支语句而打破了执行顺序。

###0.1.5 处理器高级话题

分支预测：

|名称|优点|缺点|实际应用|
|：-------|：-------|：------|
|拖延流水线|简单，无需冲刷|性能损失|早期流水线IBM360
|分支预测未被采取|少量硬件|需要冲刷指令|绝大多数使用的方法，也混合使用目标预测
|分支预测采取|性能好，硬件要求高|硬件要求更高|——————————
|延时分支|不需要额外的硬件，靠编译器|流水线过深，需要根据实际硬件于编译器|旧式的MIPS，PA-RISC，SPARC

指令集并行：
“指令级并行 ILP”的含义是：如果程序中相邻的一组指令是相互独立的，即不竞争同一个功能部件、不相互等待对方的运算结果、不访问同一个存储单元，那么它们就可以在处理器内部并行地执行。

更深的流水线的原因：
访问时间的相对增加。
访问ROM微码。
多个功能单元。
浮点运算专用流水线。
乱序执行和重排序缓存。
寄存器重命名。
基于硬件的投机执行。


超标量：
超标量（Superscalar）技术 和 超长指令字（Very Long Instruction Word, VLIW）技术是目前最基本的两类指令级并行技术。
前者的特点是采用普通的指令，设置多条并行工作的指令流水线；后者的特点是：将若干条普通指令组装在一起，形成一条“超级指令”。这条“超级指令”包含多个不同操作码，这些操作码分别处理不同的操作数。对应这些操作码，一一对应地设置相应的功能部件。这样，只要取指令一次、分析指令一次，VLIW 技术就可以实现对多个不同的操作数，同时进行不同的处理/计算。
Intel 公司的 Pentium 微处理器的实现采用了超标量技术，设置了两条相同的整数流水线（分别叫 U 流水线和 V 流水线）和一条浮点数流水线。浮点数流水线中又进一步采用多功能部件的思想，设置了加法器、乘法器和除法器。
目前，主流的微处理器都采用了超标量技术。


###参考资料
【1】http://www.nowamagic.net/librarys/veda/detail/2360